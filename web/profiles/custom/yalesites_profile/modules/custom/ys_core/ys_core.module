<?php

/**
 * @file
 * Contains ys_core.module functions.
 */

use Drupal\Core\Cache\Cache;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Render\Element;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Url;

/**
 * @file
 * Contains ys_core.module functions.
 */

/**
 * Add template file for social links.
 *
 * Implements hook_theme().
 */
function ys_core_theme($existing, $type, $theme, $path): array {
  return [
    'ys_breadcrumb_block' => [
      'variables' => [
        'items' => [],
      ],
    ],
    'ys_support_form' => [
      'variables' => [
        'link' => NULL,
      ],
    ],
    'ys_dashboard' => [
      'variables' => [],
    ],
    'ys_dashboard_resources' => [
      'variables' => [],
    ],
    'ys_social_links' => [
      'variables' => [
        'icons' => [],
      ],
    ],
    'ys_search_form' => [
      'variables' => [],
    ],
    'ys_title_breadcrumb' => [
      'variables' => [
        'page_title' => NULL,
        'page_title_display' => NULL,
        'breadcrumbs_placeholder' => [],
      ],
    ],
    'ys_footer_block' => [
      'variables' => [
        'footer_variation' => 'basic',
        'footer_logos' => [],
        'school_logo' => NULL,
        'school_logo_url' => '/',
        'footer_text' => NULL,
        'footer_links_col_1_heading' => NULL,
        'footer_links_col_2_heading' => NULL,
        'footer_links_col_1' => [],
        'footer_links_col_2' => [],
      ],
    ],
  ];
}

/**
 * Implements hook_form_alter().
 */
function ys_core_form_alter(&$form, $form_state, $form_id) {

  // Load custom library.
  if (str_ends_with($form_id, '_layout_builder_form')) {
    $form['#attached']['library'][] = 'ys_core/node_layout_form';
  }

  // Changes wording of sticky at top of lists.
  if (isset($form['sticky'])) {
    $form['sticky']['widget']['value']['#title'] = t('Pin to the beginning of list');
  }

  // Hide Relations on taxonomy term edit page.
  $vocabularyForms = [
    'taxonomy_term_tags_form',
    'taxonomy_term_event_category_form',
    'taxonomy_term_post_category_form',
  ];

  if (in_array($form_id, $vocabularyForms)) {
    $form['relations']['#access'] = FALSE;
  }

  // Increase length of taxonomy vocabulary description field.
  if ($form_id == 'taxonomy_vocabulary_form') {
    $form['description']['#maxlength'] = 256;
  }

  // Hide core taxonomy description.
  // @see ys_core_help()
  if ($form_id == 'taxonomy_overview_vocabularies') {
    $form['#attached']['library'][] = 'ys_core/taxonomy_form';
  }

  // Add vocabulary description to the taxonomy overview form.
  if ($form_id == 'taxonomy_overview_terms') {
    $replacements['@description'] = $form_state->getBuildInfo()['args'][0]->getDescription();
    $form['help']['description'] = [
      '#type' => 'markup',
      '#markup' => "<p>" . t('@description', $replacements) . "</p>",
    ];
  }
}

/**
 * Implements hook_preprocess_block().
 */
function ys_core_preprocess_block(&$variables) {
  $config = \Drupal::config('ys_core.social_links');

  // Add the cache tag, so that the theme setting information is rebuilt
  // when the config is saved.
  // Via: https://drupal.stackexchange.com/questions/266379/how-to-clear-cache-for-config-entity-after-making-changes
  \Drupal::service('renderer')->addCacheableDependency($variables, $config);
}

/**
 * Passes the config to enable/disable search form into templates.
 *
 * Implements hook_preprocess_region().
 */
function ys_core_preprocess_region(&$variables) {
  $config = \Drupal::config('ys_core.site');
  if ($variables['elements']['#region'] == 'header' && $config->get('search')) {
    $variables['utility_nav__search'] = $config->get('search')['enable_search_form'];
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function ys_core_form_user_login_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $form['#submit'][] = 'ys_core_user_login_form_submit';
}

/**
 * Custom submit handler for the login form.
 */
function ys_core_user_login_form_submit($form, FormStateInterface $form_state) {
  $url = Url::fromRoute('<front>');
  $form_state->setRedirectUrl($url);
}

/**
 * Implements theme_preprocess_menu().
 */
function ys_core_preprocess_menu(&$variables) {
  if ($variables['menu_name'] == 'main') {
    // If submenu, add the top level link as the first link in the submenu.
    foreach ($variables['items'] as &$menuItem) {
      // Skip menu items that do not have subitems.
      if (empty($menuItem['below'])) {
        continue;
      }

      // Clone top level menu item.
      $clonedMenuItem = $menuItem;

      // We don't want any other subitems, just the top level.
      $clonedMenuItem['below'] = NULL;

      // Main menu items get the heading treatment.
      // @see component-library-twig/components/02-molecules/menu/_yds-menu-item.twig
      $clonedMenuItem['list__item__is_heading'] = TRUE;

      // Get the CTA text from menu item extras field.
      $clonedMenuItem['heading_cta'] = $clonedMenuItem['entity']->get('field_menu_top_level_link_cta')->value ?: t('Explore all');

      // Add cloned item to the beginning of the menu.
      array_unshift($menuItem['below'], $clonedMenuItem);

    }
  }

}

/**
 * Implements hook_module_implements_alter().
 */
function ys_core_module_implements_alter(&$implementations, $hook) {
  // Forces ys_core help hook to come before others.
  // @see https://drupal.stackexchange.com/questions/242572/is-it-possible-to-modify-help-text-on-a-vocabulary-page
  if ($hook == 'help') {
    $implementations = ['ys_core' => $implementations['ys_core']] + $implementations;
  }
}

/**
 * Implements hook_help().
 */
function ys_core_help($route_name, RouteMatchInterface $route_match) {
  // Overrides help description.
  // This is "temporary" until core adds this functionality.
  // Uses CSS to hide the core description.
  // @see https://drupal.stackexchange.com/questions/242572/is-it-possible-to-modify-help-text-on-a-vocabulary-page
  // @see https://www.drupal.org/project/drupal/issues/487386
  switch ($route_name) {
    case 'entity.taxonomy_vocabulary.collection':

      $output = '<p class="replacement-taxonomy-help">' . t('Taxonomy is used to classify website content into groups called vocabularies. Each vocabulary contains a set of terms used to categorize content. For example, an "Event Type" vocabulary contains terms like "Online" and "In-Person". This allows for easy categorization and organization of content on a website.') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_page_attachments().
 */
function ys_core_page_attachments(array &$page) {
  // Add Siteimprove Javascript only on production.
  $config = \Drupal::config('config_split.config_split.production_config');
  if ($config->get('status')) {
    $page['#attached']['library'][] = 'ys_core/siteimprove';
  }

  // Custom or fallback favicons.
  $favicons = \Drupal::service('ys_core.favicon_manager')->getFavicons();
  foreach ($favicons as $name => $favicon) {
    $page['#attached']['html_head'][] = [$favicon, $name];
  }

}

/**
 * Implements hook_preprocess_image_widget() for SiteSettingsForm.php.
 */
function ys_core_preprocess_image_widget(&$variables) {
  /*
   * Used for previewing the managed file for favicons and others.
   * @see web/profiles/custom/yalesites_profile/modules/custom/ys_core/src/Form/SiteSettingsForm.php
   * @see
   * https://drupal.stackexchange.com/questions/212480/form-api-image-preview
   */
  $element = $variables['element'];

  if (isset($element['#use_favicon_preview'])) {

    $variables['attributes'] = [
      'class' => [
        'image-widget',
        'js-form-managed-file',
        'form-managed-file',
        'clearfix',
      ],
    ];

    $config = \Drupal::config('system.site');
    $variables['site_name'] = $config->get('name');

    if (!empty($element['fids']['#value'])) {
      $file = reset($element['#files']);
      $element['file_' . $file->id()]['filename']['#suffix'] = ' <span class="file-size">(' . format_size($file->getSize()) . ')</span> ';
      $file_variables = [
        'style_name' => $element['#preview_image_style'],
        'uri' => $file->getFileUri(),
      ];

      // Determine image dimensions.
      if (isset($element['#value']['width']) && isset($element['#value']['height'])) {
        $file_variables['width'] = $element['#value']['width'];
        $file_variables['height'] = $element['#value']['height'];
      }
      else {
        $image = \Drupal::service('image.factory')->get($file->getFileUri());
        if ($image->isValid()) {
          $file_variables['width'] = $image->getWidth();
          $file_variables['height'] = $image->getHeight();
        }
        else {
          $file_variables['width'] = $file_variables['height'] = NULL;
        }
      }

      $element['preview'] = [
        '#weight' => -10,
        '#theme' => 'image_style',
        '#width' => $file_variables['width'],
        '#height' => $file_variables['height'],
        '#style_name' => $file_variables['style_name'],
        '#uri' => $file_variables['uri'],
      ];

      // Store the dimensions in the form so the file doesn't have to be
      // accessed again. This is important for remote files.
      $element['width'] = [
        '#type' => 'hidden',
        '#value' => $file_variables['width'],
      ];
      $element['height'] = [
        '#type' => 'hidden',
        '#value' => $file_variables['height'],
      ];
    }
    else {
      $variables['fallback_image'] = TRUE;
    }

    // Sets a twig variable to use the favicon preview.
    // @see web/themes/custom/ys_admin_theme/templates/content-edit/image-widget.html.twig
    $variables['use_favicon_preview'] = $element['#use_favicon_preview'];

    $variables['data'] = [];
    foreach (Element::children($element) as $child) {
      $variables['data'][$child] = $element[$child];
    }
  }
}

/**
 * Implements hook_ENTITY_update().
 *
 * Clears the cache for rendered items on taxonomy term update.
 */
function ys_core_taxonomy_term_update() {
  Cache::invalidateTags(['rendered']);
}
