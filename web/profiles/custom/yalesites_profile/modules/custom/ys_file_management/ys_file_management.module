<?php

/**
 * @file
 * Contains main module functions for ys_file_management.
 */

use Drupal\media\MediaInterface;
use Drupal\Core\Entity\EntityFormInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\ys_file_management\Form\YsMediaDeleteMultipleForm;
use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\ys_file_management\Form\YsMediaDeleteForm;
use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_entity_type_alter().
 */
function ys_file_management_entity_type_alter(array &$entity_types) {
  if (!empty($entity_types['media'])) {
    assert($entity_types['media'] instanceof EntityTypeInterface);
    // Override the delete form with our custom form.
    $entity_types['media']->setFormClass('delete', YsMediaDeleteForm::class);
    // Override the bulk delete form with our custom form.
    $entity_types['media']->setFormClass('delete-multiple-confirm', YsMediaDeleteMultipleForm::class);
  }
}

/**
 * Implements hook_module_implements_alter().
 */
function ys_file_management_module_implements_alter(&$implementations, $hook) {
  if ($hook === 'entity_type_alter') {
    // Move our implementation to the end to ensure it runs after
    // media_file_delete.
    $group = $implementations['ys_file_management'];
    unset($implementations['ys_file_management']);
    $implementations['ys_file_management'] = $group;
  }
}

/**
 * Implements hook_form_alter().
 */
function ys_file_management_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  // Only modify media delete forms.
  $form_object = $form_state->getFormObject();
  if (!$form_object instanceof EntityFormInterface) {
    return;
  }

  $entity = $form_object->getEntity();
  if (!$entity instanceof MediaInterface) {
    return;
  }

  // Only modify file-based media.
  if (!ys_file_management_is_file_based_media($entity)) {
    return;
  }

  // Only modify delete forms.
  $delete_form_classes = [
    'Drupal\ys_file_management\Form\YsMediaDeleteForm',
    'Drupal\ys_file_management\Form\YsMediaDeleteMultipleForm',
  ];
  $is_delete_form = FALSE;
  foreach ($delete_form_classes as $class) {
    if ($form_object instanceof $class) {
      $is_delete_form = TRUE;
      break;
    }
  }

  if (!$is_delete_form) {
    return;
  }

  // If Entity Usage has added its warning, append our recommendations.
  if (isset($form['entity_usage_delete_warning'])) {
    $existing_messages = $form['entity_usage_delete_warning']['#message_list']['warning'] ?? [];

    // Append our recommendation to the existing warning messages.
    $existing_messages[] = t("We strongly recommend using file usage to ensure it's not associated with any blocks before deleting.");

    // If force delete checkbox exists, add additional warning about it.
    if (isset($form['force_delete_file']) || isset($form['force_delete_bulk'])) {
      $existing_messages[] = t("Force deleting will bypass usage checks and may break other content.");
    }

    $form['entity_usage_delete_warning']['#message_list']['warning'] = $existing_messages;
  }
}

/**
 * Checks if a media entity has a file-based bundle that we should manage.
 *
 * @param \Drupal\Core\Entity\EntityInterface $media
 *   The media entity to check.
 *
 * @return bool
 *   TRUE if this is a file-based media bundle, FALSE otherwise.
 */
function ys_file_management_is_file_based_media(EntityInterface $media) {
  if ($media->getEntityTypeId() !== 'media') {
    return FALSE;
  }

  // Only handle media bundles that have physical files on the server.
  $file_based_bundles = ['image', 'document', 'background_video'];
  return in_array($media->bundle(), $file_based_bundles);
}
