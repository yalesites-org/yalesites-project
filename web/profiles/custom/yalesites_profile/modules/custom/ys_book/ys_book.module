<?php

/**
 * @file
 * YaleSites Book overrides module.
 *
 * This module overrides default book module text.
 */

use Drupal\node\NodeInterface;
use Drupal\Core\Render\Element;
use Drupal\Core\Render\Markup;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Url;

/**
 * Implements hook_form_FORM_ID_alter().
 */
function ys_book_form_node_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  /*
   * Only allow the following content types to be part of a book. This is
   * because the book module permissions tie the `administer book outlines`
   * permission to show this option on node edit forms as well.
   */
  $config = \Drupal::config('book.settings');
  $allowedTypes = $config->get('allowed_types');

  /** @var Drupal\node\NodeForm $form_object */
  $form_object = $form_state->getFormObject();
  /** @var Drupal\node\Entity\Node $node */
  $node = $form_object->getEntity();

  if (!in_array($node->getType(), $allowedTypes)) {
    $form['book'] = [
      '#access' => FALSE,
    ];
  }
}

/**
 * Implements hook_module_implements_alter().
 */
function ys_book_module_implements_alter(&$implementations, $hook) {
  // Disable core book module hooks that we override.
  // - help: We provide custom help text
  // - node_view: We handle navigation rendering via template instead.
  if (in_array($hook, ['help', 'node_view'])) {
    unset($implementations['book']);
  }
}

/**
 * Implements hook_help().
 */
function ys_book_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {

    case 'book.admin':
      return '<p>' . t('Content Collections provide a way to create secondary navigation on your webpage. When you organize content into Collections, they become navigation sections. Your content can appear in both the main navigation and Content Collections') . '</p>';

    case 'entity.node.book_outline_form':
      return '<p>' . t('The outline feature allows you to include pages in the <a href=":book">Collection hierarchy</a>, as well as move them within the hierarchy or to <a href=":book-admin">reorder an entire collection</a>.',
        [
          ':book' => Url::fromRoute('book.render')->toString(),
          ':book-admin' => Url::fromRoute('book.admin')->toString(),
        ]) . '</p>';
  }
}

/**
 * Implements hook_form_alter().
 */
function ys_book_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $nodeFormIds = [
    'node_page_form',
    'node_page_edit_form',
  ];

  // Handle node edit forms with book outline fieldset.
  if (in_array($form_id, $nodeFormIds)) {
    $form['book']['#title'] = t('Content Collection');
    $form['book']['bid']['#title'] = t('Collection');
    $form['book']['bid']['#description'] = t('Your page will be a part of the selected collection');
    $form['book']['help_text'] = [
      '#type' => 'markup',
      '#markup' => t('Content Collections provide a way to create secondary navigation on your webpage. When you organize content into Collections, they become navigation sections. Your content can appear in both the main navigation and Content Collections'),
      '#weight' => -10,
    ];

    // Replace prefix.
    if (isset($form['book']['pid']['#prefix'])) {
      $form['book']['pid']['#prefix'] = str_replace(
        '<em>' . t('No book selected.') . '</em>',
        '<em>' . t('No collection selected.') . '</em>',
        $form['book']['pid']['#prefix']
      );
    }
  }

  // Handle book outline form (appears at /node/[nid]/outline).
  // Form ID pattern is node_{content_type}_book_outline_form.
  if (strpos($form_id, '_book_outline_form') !== FALSE) {
    // Change "Book outline" fieldset title to "Collection outline".
    if (isset($form['book']['#title'])) {
      $form['book']['#title'] = t('Collection outline');
    }

    // Change "Book" to "Collection" and update description.
    if (isset($form['book']['bid']['#title'])) {
      $form['book']['bid']['#title'] = t('Collection');
    }
    if (isset($form['book']['bid']['#description'])) {
      $form['book']['bid']['#description'] = t('Your page will be a part of the selected collection.');
    }

    // Update button text.
    if (isset($form['actions']['submit']['#value'])) {
      $current_value = (string) $form['actions']['submit']['#value'];
      $form['actions']['submit']['#value'] = str_replace(
        ['book outline', 'book'],
        ['collection outline', 'collection'],
        $current_value
      );
    }

    if (isset($form['actions']['delete']['#title'])) {
      $form['actions']['delete']['#title'] = t('Remove from collection outline');
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for book_remove_form.
 */
function ys_book_form_book_remove_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Override the description to use YaleSites terminology.
  // In book 2.0.4+, the form uses ConfirmFormBase which renders description
  // via getDescription() method, but we can still override the #markup.
  // Get the node from the form state build info.
  $build_info = $form_state->getBuildInfo();
  if (isset($build_info['args'][0]) && $build_info['args'][0] instanceof NodeInterface) {
    $node = $build_info['args'][0];
    $form['description']['#markup'] = t("Remove '%title' from the collection? You can add it back later using the Content Collection tab in Manage Settings.", ['%title' => $node->label()]);
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for book_admin_edit.
 */
function ys_book_form_book_admin_edit_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Replace "book outline" with "collection outline" in the form title.
  if (isset($form['#title'])) {
    $title = (string) $form['#title'];
    $new_title = str_replace('book outline', 'collection outline', $title);
    // Mark as safe HTML to preserve the markup.
    $form['#title'] = Markup::create($new_title);
  }

  // Update save button text from "Save book pages" to "Save collection".
  if (isset($form['save']['#value'])) {
    $form['save']['#value'] = t('Save collection');
  }

  // Add required indicator to all title fields in the book admin table.
  if (isset($form['table'])) {
    /** @var \Drupal\book\BookManagerInterface $bookManager */
    $bookManager = \Drupal::service('book.manager');
    $destination = \Drupal::destination()->getAsArray();

    foreach (Element::children($form['table']) as $key) {
      if (isset($form['table'][$key]['title'])) {
        $form['table'][$key]['title']['#required'] = TRUE;
      }

      // Add Remove action to operations column if it exists.
      if (isset($form['table'][$key]['operations']) && isset($form['table'][$key]['#nid'])) {
        $nid = $form['table'][$key]['#nid'];
        /** @var \Drupal\node\NodeInterface $node */
        $node = \Drupal::entityTypeManager()->getStorage('node')->load($nid);

        if ($node && $bookManager->checkNodeIsRemovable($node)) {
          $form['table'][$key]['operations']['#links']['remove'] = [
            'title' => t('Remove'),
            'url' => Url::fromRoute('entity.node.book_remove_form', ['node' => $nid]),
            'query' => $destination,
          ];
        }
      }
    }
  }
}

/**
 * Implements hook_menu_links_discovered_alter().
 */
function ys_book_menu_links_discovered_alter(&$links) {
  // Target the menu item with the route 'book.admin'.
  if (isset($links['book.admin'])) {
    $links['book.admin']['title'] = t('Content Collections');
  }
}

/**
 * Implements hook_preprocess_page_title().
 */
function ys_book_preprocess_page_title(&$variables) {
  // Replace "book outline" with "collection outline" in page titles.
  $route_name = \Drupal::routeMatch()->getRouteName();
  if ($route_name === 'book.admin_edit') {
    if (isset($variables['title'])) {
      $title = $variables['title'];
      // Handle both string and render array formats.
      if (is_array($title)) {
        $title = \Drupal::service('renderer')->renderPlain($title);
      }
      $title = (string) $title;
      $new_title = str_replace('book outline', 'collection outline', $title);
      // Mark as safe HTML to preserve the markup.
      $variables['title'] = Markup::create($new_title);
    }
  }
}

/**
 * Implements hook_library_info_alter().
 */
function ys_book_library_info_alter(&$libraries, $extension) {
  // Replaces the book module JS with one from YS Core to change wording.
  if ($extension == 'book') {
    $new_path = '/' . \Drupal::service('extension.list.module')->getPath('ys_book') . '/js';
    $new_js = [];
    $replacements = [
      'js/book.js' => $new_path . '/book.js',
    ];
    foreach ($libraries['drupal.book']['js'] as $source => $options) {
      if (isset($replacements[$source])) {
        $new_js[$replacements[$source]] = $options;
      }
      else {
        $new_js[$source] = $options;
      }
    }
    $libraries['drupal.book']['js'] = $new_js;

  }
}
