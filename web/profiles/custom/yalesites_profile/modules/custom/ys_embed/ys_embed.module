<?php

/**
 * @file
 * Primary module hooks for ys_embed module.
 */

use Drupal\Core\Render\Element;
use Drupal\Core\Template\Attribute;

/**
 * Implements hook_theme().
 */
function ys_embed_theme() {
  return [
    'field__media__field_media_embed' => [
      'variables' => [
        'element' => NULL,
        'items' => NULL,
        'label' => NULL,
        'label_display' => NULL,
        'attributes' => NULL,
      ],
      'template' => 'field--media--field-media-embed',
      'render element' => 'element',
    ],
  ];
}

/**
 * Implements hook_preprocess_block().
 */
function ys_embed_preprocess_block(&$variables) {
  if ($variables['plugin_id'] === 'inline_block:embed') {
    $variables['content']['field_media'][0]['#field_type'] = 'text';
    $variables['content']['field_media'][0]['#field_name'] = 'field_media_embed';
    $variables['content']['field_media'][0]['#entity_type'] = 'media';
    $variables['content']['field_media'][0]['#bundle'] = 'embed';
    $variables['content']['field_media'][0]['#label_display'] = 'hidden';
    $variables['content']['field_media'][0]['#title'] = '';
    $variables['content']['field_media'][0]['#is_multiple'] = FALSE;
  }
}

/**
 * Implements hook_preprocess_field().
 */
function ys_embed_preprocess_field(&$variables) {
  if ($variables['field_name'] === 'field_media_embed') {
    $variables['element']['#field_type'] = 'text';
    $variables['element']['#field_name'] = 'field_media_embed';
    $variables['element']['#entity_type'] = 'media';
    $variables['element']['#bundle'] = 'embed';
    $variables['element']['#label_display'] = 'hidden';
    $variables['element']['#title'] = '';
    $variables['element']['#is_multiple'] = FALSE;

    $embed_code = $variables['element']['#items'][0]->getValue()['value'] ?? '';
    if (empty($embed_code)) {
      return;
    }

    // Check if this is a weekly grid embed.
    if (strpos($embed_code, 'hours_grid.js?002') !== FALSE) {
      $variables['element']['#attributes']['class'][] = 'embed-libcal-weekly';
    }
    // Check if this is a daily hours embed.
    elseif (strpos($embed_code, 'hours_today.js') !== FALSE) {
      $variables['element']['#attributes']['class'][] = 'embed-libcal-daily';
    }
  }
}

/**
 * Implements hook_page_attachments_alter().
 */
function ys_embed_page_attachments_alter(array &$attachments) {
  // Add our custom CSS and JS files.
  $attachments['#attached']['html_head'][] = [
    [
      '#tag' => 'link',
      '#attributes' => [
        'rel' => 'stylesheet',
        'href' => '/profiles/custom/yalesites_profile/modules/custom/ys_embed/css/embed.css',
      ],
    ],
    'ys_embed_embed_css',
  ];
  $attachments['#attached']['html_head'][] = [
    [
      '#tag' => 'script',
      '#attributes' => [
        'src' => '/profiles/custom/yalesites_profile/modules/custom/ys_embed/js/embed.js',
      ],
    ],
    'ys_embed_embed_js',
  ];
}
